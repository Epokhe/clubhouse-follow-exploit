import json
import requests

from typing import Tuple


def _build_headers(user_id: int, auth_token: str, device_id: str):
    return {
        "Accept": "application/json",
        "Accept-Language": "tr-TR;q=1",
        "Authorization": f"Token {auth_token}",
        "CH-AppBuild": "269",
        "CH-AppVersion": "0.1.25",
        "CH-DeviceId": device_id,
        "CH-Languages": "tr-TR",
        "CH-Locale": "en_TR",
        "CH-UserID": str(user_id),
        "Connection": "keep-alive",
        "Content-Type": "application/json; charset=utf-8",
        "User-Agent": "clubhouse/269 (iPhone; iOS 14.3; Scale/2.00)",
    }


def get_current_followers(
    user_id: int, auth_token: str, device_id: str, cfduid: str
) -> int:
    r = requests.post(
        "https://www.clubhouseapi.com/api/get_profile",
        data=f'{{"user_id":{user_id}}}',
        headers=_build_headers(user_id, auth_token, device_id),
        cookies={"__cfduid": cfduid},
    )
    return json.loads(r.text)["user_profile"]["num_followers"]


def send_follow_request(
    user_id: int, auth_token: str, device_id: str, cfduid: str, target_user_id: int
) -> Tuple[int, str]:
    r = requests.post(
        "https://www.clubhouseapi.com/api/follow",
        data=f'{{"source_topic_id":null,"user_ids":null,"user_id":{target_user_id},"source":6}}',
        headers=_build_headers(user_id, auth_token, device_id),
        cookies={"__cfduid": cfduid},
    )

    return (r.status_code, r.text)
