import threading
import requests
from time import sleep, time
import os
import sys
import logging
import json
from contextlib import contextmanager
from typing import Iterator, Tuple

from config import UserConfig, Config

from request import get_current_followers, send_follow_request

from follower import start_follow_checker, start_infinite_followers


log_formatter = logging.Formatter(
    "%(asctime)s [%(threadName)s] [%(levelname)s]  %(message)s"
)
logger = logging.getLogger()
logger.setLevel(logging.DEBUG)

file_handler = logging.FileHandler(f"{os.getcwd()}/history.log")
file_handler.setFormatter(log_formatter)
file_handler.setLevel(logging.DEBUG)
logger.addHandler(file_handler)

console_handler = logging.StreamHandler(sys.stdout)
console_handler.setFormatter(log_formatter)
console_handler.setLevel(logging.INFO)
logger.addHandler(console_handler)

# Disabling noisy logs from requests
logging.getLogger("requests").setLevel(logging.WARNING)
logging.getLogger("urllib3").setLevel(logging.WARNING)


logger.info("Started...")
config = Config.parse_file("config.json")


start_follow_checker(config)
start_infinite_followers(config)

logger.info("Started the threads")
