import threading
import requests
from time import sleep, time
import os
import sys
import logging
from contextlib import contextmanager
from typing import Iterator, Tuple, List

from config import UserConfig, Config

from request import get_current_followers, send_follow_request


logger = logging.getLogger()


@contextmanager
def timed(description: str) -> Iterator[None]:
    start = time()
    yield
    elapsed = time() - start

    logger.debug(f"{description} took {elapsed:.2f}s")


def follower_checker(config: Config):
    while True:
        count = get_current_followers(
            user_id=config.target_user_id,
            auth_token=config.default_auth_token,
            device_id=config.device_id,
            cfduid=config.cfduid,
        )
        logger.info(f"Currently have {count} followers")
        sleep(config.follower_check_interval)


def infinite_follower(config: Config, user_config: UserConfig):
    follow_count = 0
    while True:
        logger.debug("Sending a follow request...")
        with timed("Follow request"):
            try:
                status, response = send_follow_request(
                    user_id=user_config.user_id,
                    auth_token=user_config.auth_token,
                    device_id=config.device_id,
                    cfduid=config.cfduid,
                    target_user_id=config.target_user_id,
                )
            except requests.exceptions.RequestException as e:
                logger.warn(
                    f"Stopping the follower for the user id {user_config.user_id}"
                    f"because we got an exception.\n"
                    f"Exception: {e}\n"
                    f"Since the start of the script, this user id has successfully sent {follow_count} follow requests"
                )
                break

            if status == 429:
                logger.warn(
                    f"Stopping the follower for the user id {user_config.user_id}"
                    f"because we reached the rate limit for that user.\n"
                    f"Status code: {status} - Response: {response}\n"
                    f"Since the start of the script, this user id has successfully sent {follow_count} follow requests"
                )
                break

            if status != 200:
                logger.warn(
                    f"Stopping the follower for the user id {user_config.user_id}"
                    f"because of an unexpected status code.\n"
                    f"Status code: {status} - Response: {response}\n"
                    f"Since the start of the script, this user id has successfully sent {follow_count} follow requests"
                )
                break

            follow_count += 1

        logger.debug(f"Follow request sent. Status: {status} Response: {response}")
        sleep(config.follow_interval)


def start_follow_checker(config: Config):
    t = threading.Thread(target=follower_checker, daemon=True, args=(config,))
    t.start()


def start_infinite_followers(config: Config):
    for i, user_config in enumerate(config.users):
        t = threading.Thread(
            name=f"Follower-{i}",
            target=infinite_follower,
            args=(config, user_config),
        )
        t.start()
